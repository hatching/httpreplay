#!/usr/bin/env python
# Copyright (C) 2015 Jurriaan Bremer <jbr@cuckoo.sh>
# This file is part of HTTPReplay - http://jbremer.org/httpreplay/
# See the file 'LICENSE' for copying permission.

import argparse
import logging

import click

import httpreplay.cobweb
import httpreplay.misc
import httpreplay.reader
import httpreplay.smegma
import httpreplay.test

from httpreplay.cut import (
    http_handler, https_handler, smtp_handler
)

@click.command()
@click.argument("pcapfile", type=click.File("rb"))
@click.option("--tlsmaster", type=click.Path(file_okay=True), help="TLS master secrets file")
def httpreplay(pcapfile, tlsmaster):

    logging.basicConfig(level=logging.INFO)
    log = logging.getLogger(__name__)

    if tlsmaster:
        tls_master_secrets = httpreplay.misc.read_tlsmaster(tlsmaster)
    else:
        tls_master_secrets = {}

    handlers = {
        25: smtp_handler,
        80: http_handler,
        8000: http_handler,
        8080: http_handler,
        443: lambda: https_handler(tls_master_secrets),
        4443: lambda: https_handler(tls_master_secrets),
    }

    reader = httpreplay.reader.PcapReader(pcapfile)
    reader.tcp = httpreplay.smegma.TCPPacketStreamer(reader, handlers)

    for s, ts, protocol, sent, recv in reader.process():
        print s, "%f" % ts, protocol, getattr(sent, "uri", None)

if __name__ == "__main__":
    httpreplay()
